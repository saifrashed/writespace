<!DOCTYPE html>
<html>

<head>
    <title>Test Page</title>
</head>

<body>
    <h1>Test Page</h1>

    <!-- Form to submit data -->
    <form id="submitForm">
        <label for="userId">User ID:</label>
        <input type="text" id="userId" name="userId" required><br>

        <label for="assignmentId">Assignment ID:</label>
        <input type="text" id="assignmentId" name="assignmentId" required><br>

        <label for="file">File:</label>
        <input type="file" id="file" name="file" accept="image/png" required><br>

        <button type="submit">Submit</button>
    </form>

    <!-- Button to retrieve submissions -->
    <button id="getSubmissions">Get Submissions</button>

    <!-- Display area for response -->
    <div id="response"></div>

    <!-- Script to handle form submission and GET request -->
    <script>
        const form = document.getElementById("submitForm");
        const getButton = document.getElementById("getSubmissions");
        const responseDiv = document.getElementById("response");

        form.addEventListener("submit", async (event) => {
            event.preventDefault();

            const userId = document.getElementById("userId").value;
            const assignmentId = document.getElementById("assignmentId").value;
            const file = document.getElementById("file").files[0];

            const formData = new FormData();
            formData.append("userId", userId);
            formData.append("assignmentId", assignmentId);
            formData.append("file", file);

            try {
                const response = await fetch("http://localhost:5000/submission/save", {
                    method: "POST",
                    body: formData,
                });

                const data = await response.json();
                responseDiv.textContent = JSON.stringify(data);
            } catch (error) {
                console.error(error);
                responseDiv.textContent = "Error: " + error.message;
            }
        });

        function hexArrayToBase64(hexArray) {
            // Convert integers to hexadecimal strings
            const hexStrings = hexArray.map(value => value.toString(16).padStart(2, '0'));

            // Convert hex array to string
            const hexString = hexStrings.join('');

            // Convert hex string to bytes
            const bytes = new Uint8Array(hexString.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));

            // Encode bytes to base64 string
            const base64String = btoa(String.fromCharCode.apply(null, bytes));

            return base64String;
        }

        getButton.addEventListener("click", async () => {
            try {
                const userId = "henk";
                const assignmentId = "assignment3";
                const url = `http://localhost:5000/submission/findSpecificSubmission?userId=${userId}&assignmentId=${assignmentId}`;
                const response = await fetch(url);
                const submissions = await response.json();
                responseDiv.innerHTML = "";

                submissions.forEach((submission) => {
                    const img = document.createElement("img");
                    // console.log(submission.fileData.data);
                    const base64String = hexArrayToBase64(submission.fileData.data);
                    // console.log(base64String)
                    img.src = "fileData:image/png;base64," + base64String;
                    img.style.maxWidth = "100%";
                    responseDiv.appendChild(img);
                });
            } catch (error) {
                console.error(error);
                responseDiv.textContent = "Error: " + error.message;
            }
        });

    </script>

</body>

</html>